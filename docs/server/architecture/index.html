<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Architecture Entity Component Services Entities are described by dynamically attaching components to them. ECS system have been proven as a de facto industry standard for recent game development. The components only contain the data are attached to entities which merely are an ID in the system. The so called systems act upon this data and alter the entities usually this is the case in a fixed tick amount for game logic updates.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="" />
<meta property="og:description" content="Architecture Entity Component Services Entities are described by dynamically attaching components to them. ECS system have been proven as a de facto industry standard for recent game development. The components only contain the data are attached to entities which merely are an ID in the system. The so called systems act upon this data and alter the entities usually this is the case in a fixed tick amount for game logic updates." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://docs.bestia-game.net/docs/server/architecture/" />
<meta property="article:modified_time" content="2020-05-08T02:07:53+02:00" />
<title>Architecture | Bestia Game</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.a6e2c98d287fde1ee03cdb4322ae00297d9842c96ed7d383b48098da94e04095.css" integrity="sha256-puLJjSh/3h7gPNtDIq4AKX2YQslu19ODtICY2pTgQJU=">
<script defer src="/en.search.min.685c56b85195a6149f987b2ac3736e8ca557399535b3007a0cf0b9e1d4164e5a.js" integrity="sha256-aFxWuFGVphSfmHsqw3NujKVXOZU1swB6DPC54dQWTlo="></script>

<script defer src="/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js" integrity="sha256-dKi7B/C&#43;6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><img src="/bestia-logo.svg" alt="Logo" /><span>Bestia Game</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li>
  <a href="/docs/mechanics/"><strong>Game Design</strong></a>
<ul>
<li>
  <a href="/docs/mechanics/general/">General Mechanics</a></li>
<li>
  <a href="/docs/mechanics/master/">Bestia Master</a></li>
<li>
  <a href="/docs/mechanics/bestia/">Bestia</a></li>
<li>
  <a href="/docs/mechanics/environment/">Environment</a></li>
<li>
  <a href="/docs/mechanics/items/">Items</a></li>
<li>
  <a href="/docs/mechanics/resources/">Resources</a></li>
<li>
  <a href="/docs/mechanics/skills/">Skills</a></li>
<li>
  <a href="/docs/mechanics/statusvalues/">Status Values</a></li>
<li>
  <a href="/docs/mechanics/dev-resources/">Development Resources</a></li>
</ul>
</li>
<li>
  <a href="/docs/client/"><strong>Client</strong></a>
<ul>
<li>
  <a href="/docs/client/entities/">Entities</a></li>
</ul>
</li>
<li>
  <a href="/docs/server/"><strong>Server</strong></a>
<ul>
<li>
  <a href="/docs/server/architecture/"class=active>Architecture</a></li>
<li>
  <a href="/docs/server/ai/">Artificial Intelligence</a></li>
<li>
  <a href="/docs/server/battle/">Battle</a></li>
<li>
  <a href="/docs/server/communication/">Communication</a></li>
<li>
  <a href="/docs/server/quests/">Quests</a></li>
<li>
  <a href="/docs/server/scripting/">Scripting</a></li>
<li>
  <a href="/docs/server/world-generation/">World Generation</a></li>
</ul>
</li>
<li>
  <a href="/docs/api/"><strong>REST API</strong></a></li>
</ul>










</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Architecture</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#architecture">Architecture</a>
      <ul>
        <li><a href="#entity-component-services">Entity Component Services</a></li>
        <li><a href="#entity-creators">Entity Creators</a>
          <ul>
            <li><a href="#blueprint-json-datenformat">Blueprint JSON Datenformat</a></li>
          </ul>
        </li>
        <li><a href="#entity-actor-system">Entity Actor System</a></li>
        <li><a href="#entity-resource-cleanup">Entity Resource Cleanup</a></li>
        <li><a href="#internal-messaging">Internal Messaging</a></li>
        <li><a href="#component-synchronization">Component Synchronization</a>
          <ul>
            <li><a href="#interest-management">Interest Management</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="architecture">Architecture</h1>
<h2 id="entity-component-services">Entity Component Services</h2>
<p>Entities are described by dynamically attaching components to them. ECS system have been proven as a de facto industry
standard for recent game development. The components only contain the data are attached to entities which merely are
an ID in the system. The so called systems act upon this data and alter the entities usually this is the case in a
fixed tick amount for game logic updates.. Since the bestia system is event based and not tick based we use a little
different approach. We define services which work on entities and their components. These services are triggered by
Akka Actors in case a event message arrives. This architecture is called entity component services and allows a
better usage of computing resources in a clustered server environment.</p>
<p>A entity factory will create a entity, save it into the memdb and also start a sharded entity into the cluster.
The factory will also create and setup components which might have also active actors. If a component is created,
altered or deleted these calls are intercepted via a configurable callback. Usually the component instances are
cached for some amount of time to lessen the strain on the garbage collector. Upon creation of the component a
message might get sent into the actorsystem to start up a component based actor which will then in turn control
some execution specific operation like periodic health regeneration ticks.</p>
<h2 id="entity-creators">Entity Creators</h2>
<p>The first step into an usable entity are entity creators. They take alle domain data input or simple argument input
and server as a helper function or a builder for usable a complete entities which are outfitted with components. They
create the blueprints this is a building plan for the real entity factory for entity creation. The blueprints can
either be created programmatically but they might also get statically described via JSON files which in turn then can
be loaded by the software to create static entities (the created entities can of course later then be adjusted via
scripts at runtime).</p>
<h3 id="blueprint-json-datenformat">Blueprint JSON Datenformat</h3>
<p>Blueprints are basically entity compositions described via JSON. Jackson is used to parse these files and feed them
into a special <code>BlueprintEntityFactory</code>. The components are initialized with the values given in the blueprint.</p>
<h4 id="example-dataformat">Example Dataformat</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{
  <span style="color:#a6e22e">position</span><span style="color:#f92672">:</span> {<span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>},
  <span style="color:#a6e22e">visible</span><span style="color:#f92672">:</span> {<span style="color:#a6e22e">sprite</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;type&#39;</span>},
  <span style="color:#a6e22e">script</span><span style="color:#f92672">:</span> {<span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;bla&#39;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;item&#39;</span>}
}
</code></pre></div><h2 id="entity-actor-system">Entity Actor System</h2>
<p>Bestia uses a entity actor system for management and active control of its entities. Each entity is registered via an in
memory actor. When entity interact they communicate via the Akka messaging system. Components are child actors of an
entity actor and they can send messages to other entities or components.</p>
<h2 id="entity-resource-cleanup">Entity Resource Cleanup</h2>
<p>The inner world representation relies on entities with associated component data. The problem is in order to manage this
entities in a message based way there must be also an active actor present to receive these messages and react
accordingly. This actor capsules the logic of the entity but might also have child actors if certain components require
them (like for example a script callback trigger actor which will trigger script callbacks in certain intervals). If
components or entities are deleted not only should the object instance be reused, these resources must also be reliably
cleaned up.</p>
<h2 id="internal-messaging">Internal Messaging</h2>
<p>Akka messages should only be send from actors to actors. This keeps the messaging system away from the service
structures thus allowing a clean separation of concerns.
The main entry point of message digestion is the DigestExActor. Connection and authentication Client performs
Authentication → Server accepts authentication → Webserver established connection → notifies client and
server → server spawns client entities and updates client.
Client Connection Actors hold the connection to the client and are used as a sharded actor. Updates to this
certain client are sent to the sharded actor.</p>
<h2 id="component-synchronization">Component Synchronization</h2>
<h3 id="interest-management">Interest Management</h3>
<p>To optimize performance clients are divided into certain areas called area of interest (AOI). Only clients having a
receive enabled entity (usually bestias) inside an AOI are receiving updates of what is happening around them. These
receivable entities are realized via a component attached to a entity. All such entities enable players to receive
updates. The update packets are marked with a flag from which entity the observation was done.
The server needs to keep track which entities are within a certain interest zone. This is done directly via the x and y
coordinates of an entity.</p>
<p>As soon as a transmittable Component changes the system automatically searchs for entities which needs an updated. The
updated component is then transmitted to these entities or connected players.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">



  <div><a class="flex align-center" href="https://github.com/tfelix/bestia-docs/commit/913b3dd02bf18999279326ad392a2694365fd16e" title='Last modified by Thomas Felix | May 8, 2020' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>May 8, 2020</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://github.com/tfelix/bestia-docs/edit/master/content//docs/server/architecture.md" target="_blank" rel="noopener">
      <img src="/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>

</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#architecture">Architecture</a>
      <ul>
        <li><a href="#entity-component-services">Entity Component Services</a></li>
        <li><a href="#entity-creators">Entity Creators</a>
          <ul>
            <li><a href="#blueprint-json-datenformat">Blueprint JSON Datenformat</a></li>
          </ul>
        </li>
        <li><a href="#entity-actor-system">Entity Actor System</a></li>
        <li><a href="#entity-resource-cleanup">Entity Resource Cleanup</a></li>
        <li><a href="#internal-messaging">Internal Messaging</a></li>
        <li><a href="#component-synchronization">Component Synchronization</a>
          <ul>
            <li><a href="#interest-management">Interest Management</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












